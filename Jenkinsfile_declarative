pipeline {
    agent {
        dockerfile {
            filename 'Dockerfile'
            dir '.'
            label 'zip-job-docker'
        }
    }

    environment {
        RECIPIENT_EMAIL = 'ronyzn3@gmail.com'
        ARTIFACTORY_REPO = 'binary-storage/'
        VERSION = '1.2.0'
    }
    stages {
        stage('Load Utils') {
            steps {
                script {
                    utils = load 'jenkins_utils.groovy'
                }
            }
        }

        stage('Run Job') {
            steps {
                script {
                    utils.runZipJob()
                }
            }
        }

        stage('Publish to Artifactory') {
            steps {
                script {
                    echo 'Creating Artifactory server dynamically...'
                    def server = rtServer (
                        id: 'zip-artifacts',
                        url: env.ARTIFACTORY_URL,
                        credentialsId: 'artifactory-creds',
                        bypassProxy: true,
                        timeout: 300
                    )

                    def buildInfo = server.newBuildInfo()

                    def uploadSpec = """{
                        "files": [
                            {
                                "pattern": "zipped/*.zip",
                                "target": "${env.ARTIFACTORY_REPO}${env.VERSION}/"
                            }
                        ]
                    }"""

                    echo "Uploading with spec:\n${uploadSpec}"
                    server.upload(spec: uploadSpec, buildInfo: buildInfo)
                    server.publishBuildInfo(buildInfo)
                    echo "âœ… Upload completed successfully!"
                }
            }
        }

        // stage('Report') {
        //     steps {
        //         script {
        //             utils.sendEmailReport(env.RECIPIENT_EMAIL)
        //         }
        //     }
        // }
    }

    post {
        always {
            script {
                utils.cleanWorkspace()
            }
        }
    }
}
