pipeline {
    agent {
        dockerfile {
            filename 'Dockerfile'       
            dir '.'                     
            label 'zip-job-docker'      
        }
    }

    environment {
        ARTIFACTORY_CREDS = credentials('artifactory-creds')
        RECIPIENT_EMAIL = "ronyzn3@gmail.com"
    }

    stages {
        stage('Run Job') {
            steps {
                echo "Running zip_job.py to generate zip files..."
                sh 'python3 ./job/zip_job.py'
            }
        }

        stage('Publish to Artifactory') {
            steps {
                script {
                    def server = Artifactory.server('zip-artifacts')
                    def buildInfo = Artifactory.newBuildInfo()
                    buildInfo.env.capture = true
                    def uploadSpec = """{
                        "files": [
                            {
                                "pattern": "zipped/*.zip",
                                "target": "binary-storage/${VERSION}/"
                            }
                        ]
                    }"""
                    server.upload(uploadSpec, buildInfo)
                    server.publishBuildInfo(buildInfo)
                }
            }
        }
        stage('Report'){
            steps{
            echo "Sending email report..."
            emailext body: 'A Test EMail', 
            recipientProviders: [[$class: 'DevelopersRecipientProvider'], 
            [$class: 'RequesterRecipientProvider']], 
            subject: 'Test'
        }
        }
    }

    post {
        always {
            echo "Cleaning workspace..."
            deleteDir()
        }
    }
}
