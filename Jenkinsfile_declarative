pipeline {
    agent {
        dockerfile {
            filename 'Dockerfile'
            dir '.'
            label 'zip-job-docker'
        }
    }

    environment {
        RECIPIENT_EMAIL = 'ronyzn3@gmail.com'
        ARTIFACTORY_REPO = 'binary-storage/'
        VERSION = '1.2.0'
    }
    stages {
        stage('Load Utils') {
            steps {
                script {
                    utils = load 'jenkins_utils.groovy'
                }
            }
        }

        stage('Run Job') {
            steps {
                script {
                    utils.runZipJob()
                }
            }
        }

        stage('Publish to Artifactory') {
            steps {
                script {
                    echo 'Initializing Artifactory server...'
                    def server
                    try {
                        server = Artifactory.server('zip-artifacts')
                        echo '✅ Artifactory server object created successfully.'
                    } catch (err) {
                        error "❌ Could not initialize Artifactory server: ${err.message}"
                    }
                    utils.uploadToArtifactory(server)
                }
            }
        }

        stage('Report') {
            steps {
                script {
                    utils.sendEmailReport(env.RECIPIENT_EMAIL)
                }
            }
        }
    }

    post {
        always {
            script {
                utils.cleanWorkspace()
            }
        }
    }
}
