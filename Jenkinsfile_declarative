pipeline {
    agent {
        dockerfile {
            filename 'Dockerfile'       
            dir '.'                     
            label 'zip-job-docker'      
        }
    }

    environment {
        RECIPIENT_EMAIL = "ronyzn3@gmail.com"
    }
    stages {
        stage('Load Utils') {
            steps {
                script {
                    utils = load 'jenkins_utils.groovy'
                }
            }
        }
    stages {
        stage('Run Job') {
            steps {
                script {
                    utils.runZipJob()
                }
            }
        }

        stage('Publish to Artifactory') {
            steps {
                script {
                    def server = Artifactory.server('zip-artifacts')
                    utils.uploadToArtifactory(server)
                }
            }
        }
        stage('Report'){
            steps{
                script {
                    utils.sendEmailReport(env.RECIPIENT_EMAIL)
                }
            }
        }
    }

    post {
        always {
            script {
                utils.cleanWorkspace()
            }
        }
    }
}
