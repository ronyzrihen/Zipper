pipeline {
    agent {
        dockerfile {
            filename 'Dockerfile'
            dir '.'
            label 'zip-job-docker'
        }
    }

    environment {
        RECIPIENT_EMAIL = 'ronyzn3@gmail.com'
    }
    stage('Check Artifactory Connectivity') {
    steps {
        script {
            echo "Checking connectivity to Artifactory..."
            def status = sh(script: '''
                set -e
                echo "Testing Artifactory at: http://host.docker.internal:8081/artifactory"
                curl -I --silent --max-time 5 http://host.docker.internal:8081/artifactory/api/system/ping | head -n 1
            ''', returnStdout: true).trim()

            echo "Artifactory response: ${status}"

            if (!status.contains("200")) {
                error("❌ Cannot reach Artifactory at http://host.docker.internal:8081/artifactory")
            } else {
                echo "✅ Artifactory is reachable!"
            }
        }
    }
}
    stages {
        stage('Load Utils') {
            steps {
                script {
                    utils = load 'jenkins_utils.groovy'
                }
            }
        }

        stage('Run Job') {
            steps {
                script {
                    utils.runZipJob()
                }
            }
        }

        stage('Publish to Artifactory') {
            steps {
                script {
                    def server = Artifactory.server('zip-artifacts')
                    utils.uploadToArtifactory(server)
                }
            }
        }

        stage('Report') {
            steps {
                script {
                    utils.sendEmailReport(env.RECIPIENT_EMAIL)
                }
            }
        }
    }

    post {
        always {
            script {
                utils.cleanWorkspace()
            }
        }
    }
}
