pipeline {
    agent {
        dockerfile {
            filename 'Dockerfile'
            dir '.'
            label 'zip-job-docker'
        }
    }

    environment {
        RECIPIENT_EMAIL = 'ronyzn3@gmail.com'
    }
    stages {
        stage('Load Utils') {
            steps {
                script {
                    utils = load 'jenkins_utils.groovy'
                }
            }
        }

        stage('Run Job') {
            steps {
                script {
                    utils.runZipJob()
                }
            }
        }

        stage('Publish to Artifactory') {
            steps {
                script {
                    echo 'Initializing Artifactory server...'
                    def server = Artifactory.server 'zip-artifacts'
                    echo 'Artifactory server initialized.'
                    utils.uploadToArtifactory(server)
                    echo 'Upload to Artifactory stage completed.'
                }
            }
        }

        stage('Report') {
            steps {
                script {
                    utils.sendEmailReport(env.RECIPIENT_EMAIL)
                }
            }
        }
    }

    post {
        always {
            script {
                utils.cleanWorkspace()
            }
        }
    }
}
