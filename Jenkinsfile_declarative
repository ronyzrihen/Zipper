pipeline {
    agent {
        dockerfile {
            filename 'Dockerfile'
            dir '.'
            label 'zip-job-docker'
        }
    }

    environment {
        VERSION = '1.2.0'
        ARTIFACTORY_URL = 'https://artifactory-tlv'
        ARTIFACTORY_USER = 'super-user'
        ARTIFACTORY_PASS = 'Qw12856!'
        ARTIFACTORY_REPO = "binary-storage/${VERSION}/"
        RECIPIENT_EMAIL = 'ronyzn3@gmail.com'
    }

    stages {
        stage('Build') {
            steps {
                echo 'Running zip_job.py to generate zip files...'
                sh 'python3 ./job/zip_job.py'
            }
        }

        stage('Publish to Artifactory') {
            when {
                expression { currentBuild.currentResult == 'SUCCESS' }
            }
            steps {
                script {
                    echo 'Uploading artifacts to Artifactory...'
                    def server = Artifactory.server('zip-artifacts')
                    def buildInfo = Artifactory.newBuildInfo()
                    buildInfo.env.capture = true
                    def uploadSpec = """{
                        "files": [
                            {
                                "pattern": "zipped/*.zip",
                                "target": "${ARTIFACTORY_REPO}"
                            }
                        ]
                    }"""
                    server.upload(uploadSpec, buildInfo)
                    server.publishBuildInfo(buildInfo)

                    echo "Artifacts uploaded successfully to ${ARTIFACTORY_REPO}"
                }
            }
        }

        stage('Report') {
            steps {
                script {
                    def buildStatus = currentBuild.currentResult
                    def subject = "Build #${BUILD_NUMBER} - ${buildStatus}"
                    def body = """
                    <h2>ðŸ“‹ Build Report</h2>
                    <p><b>Project:</b> ${JOB_NAME}</p>
                    <p><b>Status:</b> ${buildStatus}</p>
                    <p><b>Version:</b> ${VERSION}</p>
                    <p><b>Timestamp:</b> ${new Date()}</p>
                    """

                    emailext(
                        to: "${RECIPIENT_EMAIL}",
                        subject: subject,
                        body: body,
                        mimeType: 'text/html'
                    )
                }
            }
        }
    }

    post {
        always {
            echo 'ðŸ§¹ Cleaning up workspace...'
            deleteDir()
        }
    }
}
